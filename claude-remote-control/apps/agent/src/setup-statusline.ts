/**
 * Auto-configuration for Claude Code statusLine integration.
 * Creates the statusline script and configures Claude settings at agent startup.
 */

import { readFileSync, writeFileSync, existsSync, mkdirSync, chmodSync } from 'fs';
import { homedir } from 'os';
import { join } from 'path';

const CLAUDE_SETTINGS_PATH = join(homedir(), '.claude', 'settings.json');
const STATUSLINE_DIR = join(homedir(), '.247');
const STATUSLINE_SCRIPT_PATH = join(STATUSLINE_DIR, 'statusline.sh');
const NOTIFICATION_SCRIPT_PATH = join(STATUSLINE_DIR, 'notification.sh');

// Pattern to detect old 247 hooks that need cleanup
const OLD_HOOK_PATTERN = /notify-status\.sh|packages\/hooks/;

/**
 * Ensure statusLine and hooks are configured for 247 integration.
 * Called at agent startup.
 */
export function ensureStatusLineConfigured(): void {
  try {
    ensureStatusLineScript();
    ensureNotificationScript();
    ensureClaudeSettings();
    console.log('[Setup] StatusLine and hooks configured successfully');
  } catch (err) {
    console.error('[Setup] Failed to configure statusLine:', err);
  }
}

/**
 * Create the statusline.sh script that forwards Claude Code data to the agent.
 */
function ensureStatusLineScript(): void {
  if (!existsSync(STATUSLINE_DIR)) {
    mkdirSync(STATUSLINE_DIR, { recursive: true });
  }

  const script = `#!/bin/bash
# 247 StatusLine - forwards Claude Code data to agent
# Auto-generated by 247 agent - do not edit manually

INPUT=$(cat)
TMUX_SESSION="\${CLAUDE_TMUX_SESSION:-}"

# Only forward if we're in a tmux session managed by 247
[ -z "$TMUX_SESSION" ] && exit 0

# Forward JSON to agent (add tmux_session field)
echo "$INPUT" | jq --arg ts "$TMUX_SESSION" '. + {tmux_session: $ts}' | \\
  curl -s -X POST "http://localhost:4678/api/heartbeat" \\
    -H "Content-Type: application/json" \\
    -d @- > /dev/null 2>&1 &

exit 0
`;

  writeFileSync(STATUSLINE_SCRIPT_PATH, script);
  chmodSync(STATUSLINE_SCRIPT_PATH, 0o755);
  console.log(`[Setup] Created statusLine script at ${STATUSLINE_SCRIPT_PATH}`);
}

/**
 * Create the notification.sh script that forwards Claude Code hook notifications to the agent.
 * This script is called by the Notification hook when Claude needs user attention.
 */
function ensureNotificationScript(): void {
  if (!existsSync(STATUSLINE_DIR)) {
    mkdirSync(STATUSLINE_DIR, { recursive: true });
  }

  const script = `#!/bin/bash
# 247 Notification Hook - forwards Claude Code notifications to agent
# Auto-generated by 247 agent - do not edit manually

INPUT=$(cat)
TMUX_SESSION="\${CLAUDE_TMUX_SESSION:-}"

# Only forward if we're in a tmux session managed by 247
[ -z "$TMUX_SESSION" ] && exit 0

# Forward JSON to agent (add tmux_session field)
echo "$INPUT" | jq --arg ts "$TMUX_SESSION" '. + {tmux_session: $ts}' | \\
  curl -s -X POST "http://localhost:4678/api/notification" \\
    -H "Content-Type: application/json" \\
    -d @- > /dev/null 2>&1 &

exit 0
`;

  writeFileSync(NOTIFICATION_SCRIPT_PATH, script);
  chmodSync(NOTIFICATION_SCRIPT_PATH, 0o755);
  console.log(`[Setup] Created notification script at ${NOTIFICATION_SCRIPT_PATH}`);
}

/**
 * Remove old 247 hooks from settings.json.
 * These hooks used the deprecated notify-status.sh script.
 */
function cleanupOldHooks(settings: Record<string, unknown>): boolean {
  if (!settings.hooks) return false;

  const hooksJson = JSON.stringify(settings.hooks);
  if (!OLD_HOOK_PATTERN.test(hooksJson)) return false;

  // Remove the old hooks
  delete settings.hooks;
  console.log('[Setup] Removed deprecated hooks from settings.json');
  return true;
}

/**
 * Configure Claude settings.json to use our statusLine script and Notification hook.
 * Also cleans up deprecated hooks if found.
 */
function ensureClaudeSettings(): void {
  const claudeDir = join(homedir(), '.claude');

  // Ensure .claude directory exists
  if (!existsSync(claudeDir)) {
    mkdirSync(claudeDir, { recursive: true });
  }

  // Read existing settings or start fresh
  let settings: Record<string, unknown> = {};
  if (existsSync(CLAUDE_SETTINGS_PATH)) {
    try {
      settings = JSON.parse(readFileSync(CLAUDE_SETTINGS_PATH, 'utf-8'));
    } catch {
      console.warn('[Setup] Could not parse existing settings.json, will create new');
    }
  }

  // Clean up old hooks if present
  const hooksRemoved = cleanupOldHooks(settings);

  const expectedStatusLineCommand = `bash ${STATUSLINE_SCRIPT_PATH}`;
  const expectedNotificationCommand = `bash ${NOTIFICATION_SCRIPT_PATH}`;

  // Check if statusLine is already configured correctly
  const currentStatusLine = settings.statusLine as { command?: string } | undefined;
  const statusLineConfigured = currentStatusLine?.command === expectedStatusLineCommand;

  // Check if Notification hook is already configured correctly
  const currentHooks = settings.hooks as Record<string, unknown[]> | undefined;
  const notificationHooks = currentHooks?.Notification as
    | Array<{ hooks?: Array<{ command?: string }> }>
    | undefined;
  const notificationConfigured = notificationHooks?.some((h) =>
    h.hooks?.some((hook) => hook.command === expectedNotificationCommand)
  );

  if (statusLineConfigured && notificationConfigured && !hooksRemoved) {
    console.log('[Setup] StatusLine and hooks already configured');
    return;
  }

  // Don't overwrite if user has a custom statusLine that's not ours
  if (currentStatusLine?.command && !currentStatusLine.command.includes('.247/statusline.sh')) {
    console.log('[Setup] User has custom statusLine, skipping statusLine configuration');
  } else {
    // Configure statusLine
    settings.statusLine = {
      type: 'command',
      command: expectedStatusLineCommand,
    };
  }

  // Configure Notification hook (merge with existing hooks)
  const hooks = (settings.hooks || {}) as Record<string, unknown[]>;

  // Only add our Notification hook if not already configured
  if (!notificationConfigured) {
    // Get existing Notification hooks (user-defined ones we should preserve)
    const existingNotificationHooks = (hooks.Notification || []) as Array<{
      hooks?: Array<{ command?: string }>;
    }>;

    // Filter out any old 247 notification hooks that might exist
    const userNotificationHooks = existingNotificationHooks.filter(
      (h) => !h.hooks?.some((hook) => hook.command?.includes('.247/notification.sh'))
    );

    // Add our Notification hook
    hooks.Notification = [
      ...userNotificationHooks,
      {
        matcher: '*',
        hooks: [
          {
            type: 'command',
            command: expectedNotificationCommand,
          },
        ],
      },
    ];
    settings.hooks = hooks;
    console.log('[Setup] Configured Notification hook');
  }

  writeFileSync(CLAUDE_SETTINGS_PATH, JSON.stringify(settings, null, 2));
  console.log(`[Setup] Configured Claude settings in ${CLAUDE_SETTINGS_PATH}`);
}
