/**
 * Auto-configuration for Claude Code statusLine integration.
 * Creates the statusline script and configures Claude settings at agent startup.
 */

import { readFileSync, writeFileSync, existsSync, mkdirSync, chmodSync } from 'fs';
import { homedir } from 'os';
import { join } from 'path';

const CLAUDE_SETTINGS_PATH = join(homedir(), '.claude', 'settings.json');
const STATUSLINE_DIR = join(homedir(), '.247');
const STATUSLINE_SCRIPT_PATH = join(STATUSLINE_DIR, 'statusline.sh');

/**
 * Ensure statusLine is configured for 247 integration.
 * Called at agent startup.
 */
export function ensureStatusLineConfigured(): void {
  try {
    ensureStatusLineScript();
    ensureClaudeSettings();
    console.log('[Setup] StatusLine configured successfully');
  } catch (err) {
    console.error('[Setup] Failed to configure statusLine:', err);
  }
}

/**
 * Create the statusline.sh script that forwards Claude Code data to the agent.
 */
function ensureStatusLineScript(): void {
  if (!existsSync(STATUSLINE_DIR)) {
    mkdirSync(STATUSLINE_DIR, { recursive: true });
  }

  const script = `#!/bin/bash
# 247 StatusLine - forwards Claude Code data to agent
# Auto-generated by 247 agent - do not edit manually

INPUT=$(cat)
TMUX_SESSION="\${CLAUDE_TMUX_SESSION:-}"

# Only forward if we're in a tmux session managed by 247
[ -z "$TMUX_SESSION" ] && exit 0

# Forward JSON to agent (add tmux_session field)
echo "$INPUT" | jq --arg ts "$TMUX_SESSION" '. + {tmux_session: $ts}' | \\
  curl -s -X POST "http://localhost:4678/api/heartbeat" \\
    -H "Content-Type: application/json" \\
    -d @- > /dev/null 2>&1 &

exit 0
`;

  writeFileSync(STATUSLINE_SCRIPT_PATH, script);
  chmodSync(STATUSLINE_SCRIPT_PATH, 0o755);
  console.log(`[Setup] Created statusLine script at ${STATUSLINE_SCRIPT_PATH}`);
}

/**
 * Configure Claude settings.json to use our statusLine script.
 * Respects existing custom configurations.
 */
function ensureClaudeSettings(): void {
  const claudeDir = join(homedir(), '.claude');

  // Ensure .claude directory exists
  if (!existsSync(claudeDir)) {
    mkdirSync(claudeDir, { recursive: true });
  }

  // Read existing settings or start fresh
  let settings: Record<string, unknown> = {};
  if (existsSync(CLAUDE_SETTINGS_PATH)) {
    try {
      settings = JSON.parse(readFileSync(CLAUDE_SETTINGS_PATH, 'utf-8'));
    } catch {
      console.warn('[Setup] Could not parse existing settings.json, will create new');
    }
  }

  const expectedCommand = `bash ${STATUSLINE_SCRIPT_PATH}`;

  // Check if already configured correctly
  const currentStatusLine = settings.statusLine as { command?: string } | undefined;
  if (currentStatusLine?.command === expectedCommand) {
    console.log('[Setup] StatusLine already configured');
    return;
  }

  // Don't overwrite if user has a custom statusLine that's not ours
  if (currentStatusLine?.command && !currentStatusLine.command.includes('.247/statusline.sh')) {
    console.log('[Setup] User has custom statusLine, skipping configuration');
    return;
  }

  // Configure statusLine
  settings.statusLine = {
    type: 'command',
    command: expectedCommand,
  };

  writeFileSync(CLAUDE_SETTINGS_PATH, JSON.stringify(settings, null, 2));
  console.log(`[Setup] Configured Claude statusLine in ${CLAUDE_SETTINGS_PATH}`);
}
